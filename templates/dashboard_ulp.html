<!-- templates/dashboard_ulp.html - WITH LOTTIE LOADING -->
{% extends "base.html" %}

{% block title %}Dashboard ULP{% endblock %}
{% block page_title %}Dashboard {{ unitup }}{% endblock %}

{% block content %}
<!-- =================== LOTTIE LOADING OVERLAY =================== -->
<div id="lottie-loading-overlay" style="display: none;">
    <div class="lottie-loading-content">
       <dotlottie-wc 
    id="lottie-player"
    src="https://lottie.host/88927c80-ea11-4a87-a441-13b10b539df0/MMwIijMIGo.lottie"
    style="width: 380px; height: 320px;" 
    autoplay 
    loop>
</dotlottie-wc>

        <h3 class="lottie-loading-title" id="lottie-loading-title">Processing</h3>
        <p class="lottie-loading-message" id="lottie-loading-message">
            Mohon tunggu<span class="lottie-loading-dots"></span>
        </p>
    </div>
</div>

<!-- =================== MAIN CONTENT =================== -->
<div class="row mb-4">
    <div class="col-12">
        <h3>Selamat Datang, {{ nama }}</h3>
        <p class="text-muted">Unit: {{ unitup }} | Periode: {{ blth_terakhir }}</p>
    </div>
</div>

<!-- ‚ú® INFO AUTO-BILLING dengan Riwayat Upload -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="alert-heading mb-0">
                    <i class="bi bi-clock-history"></i> ‚ö°Ô∏è History Upload DPM
                </h5>
                <div>
                    <span class="badge bg-white text-success">
                        <i class="bi bi-database-check"></i> Data Tersedia: 
                        <strong>{{ uploaded_months|length if uploaded_months else 0 }}</strong> Periode
                    </span>
                </div>
            </div>
            <hr>
            
            {% if uploaded_months %}
            <div class="mb-3">
                <div class="d-flex align-items-center mb-2">
                    <strong><i class="bi bi-calendar-check"></i> Periode Terakhir (12 Bulan):</strong>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    {% for month in uploaded_months %}
                    <span class="badge bg-white text-success border border-success px-3 py-2" 
                          style="font-size: 0.9rem;">
                        <i class="bi bi-check-circle-fill"></i> {{ month }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Upload Forms -->
<div class="row mb-4">
    <!-- =================== UPLOAD DPM BARU =================== -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-cloud-upload"></i> Upload DPM Baru
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="form-upload-dpm">
                    <input type="hidden" name="form_type" value="upload_dpm">
                    
                    <div class="mb-3">
                        <label class="form-label">Periode (BLTH)</label>
                        <input type="month" name="blth" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">File DPM (Excel)</label>
                        <input type="file" name="file_dpm" class="form-control" accept=".xlsx,.xls" required>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Upload data DPM baru, billing akan otomatis diproses
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 btn-lg">
                        <i class="bi bi-upload"></i> Upload DPM & Auto-Process
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- =================== UPDATE DPM KOREKSI =================== -->
    <div class="col-md-6">
        <div class="card h-100 border-warning">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-pencil-square"></i> <strong>Update DPM BLTH Kini</strong>
                {% if role == 'UP3' or role == 'UP3_MANAGE' %}
                    <span class="badge bg-danger">UP3 Mode</span>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="form-update-koreksi">
                    <input type="hidden" name="form_type" value="update_koreksi">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">File Update Koreksi (Excel)</label>
                        <input type="file" name="file_dpm_koreksi" class="form-control" accept=".xlsx,.xls" required>
                        <small class="text-muted">
                            <strong>Kolom wajib:</strong> BLTH, IDPEL, LWBPCABUT, LWBPPASANG, SAHLWBP
                            {% if role == 'UP3' or role == 'UP3_MANAGE' %}
                            <br><strong>Wajib tambahkan:</strong> UNITUP
                            {% endif %}
                        </small>
                    </div>
                    <button type="submit" class="btn btn-warning w-100 btn-lg">
                        <i class="bi bi-arrow-repeat"></i> Update & Auto-Refresh
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Upload DIL -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-database"></i> Upload DIL (Data Induk Langganan)
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_dil') }}" enctype="multipart/form-data" id="form-upload-dil">
                    <div class="mb-3">
                        <label class="form-label">File DIL (Excel)</label>
                        <input type="file" name="file_dil" class="form-control" accept=".xlsx,.xls" required>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Upload DIL (Cukup Kolom IDPEL & NOMORKWH)
                        </small>
                    </div>
                    <button type="submit" class="btn btn-info w-100">
                        <i class="bi bi-database"></i> Upload DIL
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row">
    <div class="col-12">
        <h5 class="mb-3">
            <i class="bi bi-bar-chart"></i> Ringkasan Data Billing
        </h5>
    </div>
    
    {% if summary %}
        {% for row in summary %}
        <div class="col-12 mb-3">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="bi bi-calendar3"></i> Periode: {{ row.blth }}</strong>
                        {% if row.unitup %}
                            <span class="badge bg-secondary ms-2">{{ row.unitup }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <a href="/view_billing?blth={{ row.blth }}&unitup_filter={{ unitup }}&auto_filter=1" 
                           class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> Lihat Detail
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col">
                            <h4 class="text-primary mb-1">{{ row.total }}</h4>
                            <small class="text-muted">Total</small>
                        </div>
                        <div class="col">
                            <h4 class="text-danger mb-1">{{ row.naik }}</h4>
                            <small class="text-muted">Naik</small>
                        </div>
                        <div class="col">
                            <h4 class="text-warning mb-1">{{ row.turun }}</h4>
                            <small class="text-muted">Turun</small>
                        </div>
                        <div class="col">
                            <h4 class="text-info mb-1">{{ row.div_na }}</h4>
                            <small class="text-muted">DIV/NA</small>
                        </div>
                        <div class="col">
                            <h4 class="text-success mb-1">{{ row.aman }}</h4>
                            <small class="text-muted">Aman</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="progress" style="height: 25px;">
                            {% set total = row.total if row.total > 0 else 1 %}
                            <div class="progress-bar bg-danger" style="width: {{ (row.naik / total * 100)|round(1) }}%">
                                {{ (row.naik / total * 100)|round(1) }}%
                            </div>
                            <div class="progress-bar bg-warning" style="width: {{ (row.turun / total * 100)|round(1) }}%">
                                {{ (row.turun / total * 100)|round(1) }}%
                            </div>
                            <div class="progress-bar bg-info" style="width: {{ (row.div_na / total * 100)|round(1) }}%">
                                {{ (row.div_na / total * 100)|round(1) }}%
                            </div>
                            <div class="progress-bar bg-success" style="width: {{ (row.aman / total * 100)|round(1) }}%">
                                {{ (row.aman / total * 100)|round(1) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                <strong>Belum ada data billing.</strong> 
                Silakan upload DPM untuk memulai, billing akan otomatis diproses.
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- =================== LOAD LOTTIE CDN =================== -->
<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.11/dist/dotlottie-wc.js" type="module"></script>

<script>
console.log('üöÄ [DASHBOARD_ULP] Script loading...');

// =================== LOTTIE LOADING FUNCTIONS ===================
function showLottieLoading(title = 'Processing', message = 'Mohon tunggu...') {
    console.log('üé¨ [LOTTIE] Show loading:', title, message);
    
    const overlay = document.getElementById('lottie-loading-overlay');
    const titleElement = document.getElementById('lottie-loading-title');
    const messageElement = document.getElementById('lottie-loading-message');
    
    if (titleElement) titleElement.textContent = title;
    if (messageElement) {
        messageElement.innerHTML = message + '<span class="lottie-loading-dots"></span>';
    }
    
    if (overlay) {
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('show'), 10);
        document.body.style.overflow = 'hidden';
    }
}

function hideLottieLoading() {
    console.log('üé¨ [LOTTIE] Hide loading');
    
    const overlay = document.getElementById('lottie-loading-overlay');
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            overlay.style.display = 'none';
            document.body.style.overflow = '';
        }, 300);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìã [DASHBOARD_ULP] DOM Ready');
    
    // =================== FILE INPUT VALIDATION ===================
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const ext = file.name.split('.').pop().toLowerCase();
                if (!['xlsx', 'xls'].includes(ext)) {
                    alert('‚ùå Hanya file Excel (.xlsx, .xls) yang diperbolehkan!');
                    e.target.value = '';
                    return;
                }
                
                const formGroup = e.target.closest('.mb-3');
                let preview = formGroup.querySelector('.file-preview');
                if (!preview) {
                    preview = document.createElement('div');
                    preview.className = 'file-preview alert alert-success py-1 px-2 mt-2 small';
                    formGroup.appendChild(preview);
                }
                preview.innerHTML = `<i class="bi bi-file-earmark-excel"></i> File: <strong>${file.name}</strong> (${(file.size / 1024).toFixed(1)} KB)`;
            }
        });
    });

    // =================== FORM SUBMIT HANDLER ===================
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const formId = form.id;
            const formType = form.querySelector('input[name="form_type"]')?.value;
            
            console.log('üì§ Form submitted:', formId, 'type:', formType);
            
            // Validate file input
            const fileInput = form.querySelector('input[type="file"]');
            if (fileInput && fileInput.required && !fileInput.files.length) {
                e.preventDefault();
                alert('‚ùå Silakan pilih file terlebih dahulu!');
                return false;
            }
            
            // Show Lottie loading with custom message
            if (formType === 'upload_dpm' || formId === 'form-upload-dpm') {
                showLottieLoading('üì§ Upload DPM', 'Sedang memproses billing otomatis, mohon tunggu');
            } 
            else if (formType === 'update_koreksi' || formId === 'form-update-koreksi') {
                showLottieLoading('üîÑ Update Koreksi DPM', 'Sedang memperbarui data & refresh billing');
            }
            else if (formId === 'form-upload-dil') {
                showLottieLoading('üì• Upload DIL', 'Sedang menyimpan data induk langganan');
            } 
            else {
                showLottieLoading('‚öôÔ∏è Processing', 'Sistem sedang memproses data');
            }

            // Disable button
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                const originalHTML = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';
                
                // Reset after timeout (fallback)
                setTimeout(() => {
                    hideLottieLoading();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }, 60000);
            }
        });
    });

    // =================== AUTO-SET CURRENT MONTH ===================
    const monthInputs = document.querySelectorAll('input[type="month"]');
    const currentMonth = new Date().toISOString().slice(0, 7);
    monthInputs.forEach(input => {
        if (!input.value) {
            input.value = currentMonth;
        }
    });

    console.log('‚úÖ Dashboard scripts loaded');
});

// =================== AUTO HIDE LOADING ON PAGE LOAD ===================
window.addEventListener('load', function() {
    console.log('üìÑ Page fully loaded');
    setTimeout(() => {
        hideLottieLoading();
    }, 500);
});
</script>

<!-- =================== CUSTOM CSS =================== -->
<style>
/* =================== LOTTIE LOADING OVERLAY STYLES =================== */
#lottie-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #ffffffd9;
    backdrop-filter: blur(8px);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#lottie-loading-overlay.show {
    opacity: 1;
}

.lottie-loading-content {
    text-align: center;
    animation: fadeInUp 0.5s ease-out;
}

.lottie-loading-title {
    color: #030101;
    font-size: 1.8rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.lottie-loading-message {
    color: #090404;
    font-size: 1rem;
    margin-bottom: 1rem;
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
}

.lottie-loading-dots::after {
    content: '...';
    animation: ellipsis 1.5s infinite;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes ellipsis {
    0% { content: ''; }
    25% { content: '.'; }
    50% { content: '..'; }
    75% { content: '...'; }
    100% { content: ''; }
}

/* =================== EXISTING DASHBOARD STYLES =================== */
.file-preview {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    transition: transform 0.2s, box-shadow 0.2s;
    border-radius: 12px;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.card-header {
    font-weight: 600;
    border-bottom: none;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.2s;
}

.btn-lg:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}

.progress-bar {
    font-size: 0.75rem;
    font-weight: bold;
    transition: width 0.6s ease;
}

.badge {
    font-weight: 500;
    padding: 0.5em 0.8em;
}

/* =================== RESPONSIVE =================== */
@media (max-width: 768px) {
    .lottie-loading-title {
        font-size: 1.4rem;
    }
    
    .lottie-loading-message {
        font-size: 0.9rem;
    }
    
    #lottie-player {
        width: 250px !important;
        height: 250px !important;
    }
    
    .card {
        margin-bottom: 1rem;
    }
    
    .btn-lg {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}