{% extends "base.html" %}

{% block title %}Data Billing - SnapBill{% endblock %}

{% block extra_css %}
<style>
    body { font-size: 11px !important; }
    
    .sticky-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 6px 0 !important;
        margin-bottom: 6px !important;
    }
    
    .sticky-header h2 {
        font-size: 1.1rem;
        margin: 0;
        line-height: 1.2;
    }
    
    .sticky-header .badge {
        font-size: 0.7rem;
        padding: 3px 6px;
    }
    
    .card {
        margin-bottom: 6px;
        border: 1px solid #dee2e6;
    }
    
    .card-body {
        padding: 8px;
    }
    
    .card-header {
        padding: 5px 8px;
        font-size: 0.9rem;
    }
    
    .card-header h5 {
        font-size: 0.9rem;
        margin: 0;
        font-weight: 600;
    }
    
    .row.g-3 {
        row-gap: 6px !important;
    }
    
    .form-label {
        margin-bottom: 2px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .form-select, .form-control {
        font-size: 0.75rem;
        padding: 3px 6px;
        height: 26px;
    }
    
    textarea.form-control {
        height: auto !important;
    }
    
    .btn {
        padding: 3px 10px;
        font-size: 0.75rem;
        line-height: 1.3;
    }
    
    .input-group-text {
        padding: 3px 6px;
        font-size: 0.75rem;
    }
    
    .nav-tabs {
        margin-bottom: 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
        padding: 4px 10px;
        font-size: 0.75rem;
        border-radius: 3px 3px 0 0;
        margin-right: 2px;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #0d6efd;
        color: white !important;
        font-weight: 600;
    }
    
    .nav-tabs .nav-link:not(.active) {
        background-color: #f1f3f5;
    }
    
 /* ‚≠ê UPDATE: Table Responsive dengan Sticky Header */
    .table-responsive {
        font-size: 0.7rem;
        max-height: calc(100vh - 320px);
        overflow: auto;
        border: 2px solid #495057;
        position: relative; /* ‚≠ê TAMBAH INI */
    }
    
    table {
        margin-bottom: 0;
        width: 100%;
        border-collapse: separate; /* ‚≠ê UBAH dari collapse ke separate */
        border-spacing: 0; /* ‚≠ê TAMBAH INI */
        border: 1px solid #495057;
    }
    
    /* ‚≠ê UPDATE: Sticky Header yang Lebih Kuat */
    table thead th {
        position: -webkit-sticky; /* ‚≠ê TAMBAH untuk Safari */
        position: sticky;
        top: 0; /* ‚≠ê Pastikan ini ada */
        background: #0d6efd;
        color: white;
        font-weight: 600;
        padding: 4px 6px;
        white-space: nowrap;
        font-size: 0.7rem;
        border: 1px solid #fff;
        border-right: 1px solid #0a58ca;
        border-bottom: 2px solid #0a58ca;
        z-index: 100; /* ‚≠ê UBAH dari 10 ke 100 */
        line-height: 1.2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* ‚≠ê TAMBAH shadow */
    }
    
    /* ‚≠ê TAMBAH: Pastikan header tetap di atas saat sorting */
    table thead th.sorted {
        background-color: #0a58ca !important;
        z-index: 101; /* ‚≠ê Lebih tinggi dari header lain */
    }
    
    table tbody td {
        padding: 3px 6px;
        vertical-align: middle;
        border: 1px solid #ced4da;
        border-right: 1px solid #adb5bd;
        border-bottom: 1px solid #adb5bd;
        white-space: nowrap;
        line-height: 1.2;
        background-color: white; /* ‚≠ê TAMBAH explicit background */
    }
    
    table tbody tr:nth-child(even) td {
        background-color: #f8f9fa;
    }
    
    table tbody tr:hover td {
        background-color: #e7f1ff !important;
        cursor: pointer;
    }

    /* ... CSS lainnya tetap sama ... */
    
    /* ‚≠ê UPDATE: Sorting Icons - pastikan tidak menutupi teks header */
    table thead th {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 24px !important; /* ‚≠ê UBAH dari 20px ke 24px */
    }
    
    table thead th.sortable::after {
        content: "‚áÖ";
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%); /* ‚≠ê TAMBAH untuk center vertikal */
        opacity: 0.3;
        font-size: 0.8rem;
    }
    
    table thead th.sortable:hover::after {
        opacity: 0.6;
    }
    
    table thead th.sort-asc::after {
        content: "‚ñ≤";
        opacity: 1;
        color: #ffd700;
    }
    
    table thead th.sort-desc::after {
        content: "‚ñº";
        opacity: 1;
        color: #ffd700;
    }


    .highlight {
        background-color: #90EE90 !important;
        font-weight: 600;
    }
    
    .sahlwbp-header {
        background-color: #0a58ca !important;
    }
    
    .sahlwbp-cell-blue {
        background-color: #e7f1ff !important;
    }
    
    .sahlwbp-cell-blue-positive {
        background-color: #cfe2ff !important;
        font-weight: 600;
    }
    
    .table-responsive::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .bi {
        font-size: 0.8rem;
    }
    
    .pagination {
        margin: 8px 0;
        justify-content: center;
    }
    
    .pagination .page-link {
        padding: 3px 8px;
        font-size: 0.75rem;
        margin: 0 2px;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .loading-overlay.show {
        display: flex;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d6efd;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .row-limit-selector {
        display: inline-block;
        margin-left: 10px;
    }
    
    .row-limit-selector select {
        width: auto;
        display: inline-block;
    }
    
    /* Tombol Simpan Verifikasi Sticky */
    #saveVerifikasiBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        padding: 10px 20px;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
    }
    
    #saveVerifikasiBtn.show {
        display: block;
        animation: bounceIn 0.4s ease-out;
    }
    
    @keyframes bounceIn {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* Input di tabel untuk verifikasi */
    .verifikasi-input {
        font-size: 0.7rem;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        width: 100%;
        background: #fffacd;
    }
    
    .verifikasi-input:focus {
        background: white;
        border-color: #0d6efd;
        outline: none;
    }
    
    .verifikasi-select {
        font-size: 0.7rem;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        width: 100%;
        background: #fffacd;
    }
    
    .verifikasi-select:focus {
        background: white;
        border-color: #0d6efd;
    }
    
    .verifikasi-textarea {
        font-size: 0.7rem;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        width: 100%;
        min-height: 40px;
        resize: vertical;
        background: #fffacd;
    }
    
    .verifikasi-textarea:focus {
        background: white;
        border-color: #0d6efd;
        outline: none;
    }
    
    /* Badge untuk menandai ada perubahan */
    .has-changes {
        background-color: #fff3cd !important;
        border-left: 3px solid #ffc107;
    }


table tbody tr.active-row,
table.dataTable tbody tr.active-row {
    background-color: #d8f3dc !important; /* hijau muda lembut */
    color: #1b4332 !important;            /* teks hijau tua */
    font-weight: 600 !important;
    transition: background-color 0.3s ease, color 0.3s ease;
    border-left: 4px solid #40916c !important; /* garis kiri lembut */
}

/* Hover state untuk baris aktif */
table tbody tr.active-row:hover,
table.dataTable tbody tr.active-row:hover {
    background-color: #b7e4c7 !important; /* sedikit lebih gelap saat hover */
}

/* Pastikan cell di dalam baris aktif ikut berubah */
table tbody tr.active-row td,
table.dataTable tbody tr.active-row td {
    background-color: inherit !important;
    color: inherit !important;
}

 /* Sorting Icons */
    table thead th {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
    }
    
    table thead th.sortable::after {
        content: "‚áÖ";
        position: absolute;
        right: 6px;
        opacity: 0.3;
        font-size: 0.8rem;
    }
    
    table thead th.sortable:hover::after {
        opacity: 0.6;
    }
    
    table thead th.sort-asc::after {
        content: "‚ñ≤";
        opacity: 1;
        color: #ffd700;
    }
    
    table thead th.sort-desc::after {
        content: "‚ñº";
        opacity: 1;
        color: #ffd700;
    }
    
    /* Highlight sorted column */
    table thead th.sorted {
        background-color: #0a58ca !important;
    }
    
    table tbody td.sorted-column {
        background-color: #f0f8ff !important;
    }
    
    table tbody tr:nth-child(even) td.sorted-column {
        background-color: #e6f2ff !important;
    }
    
    table tbody tr.active-row td.sorted-column {
        background-color: inherit !important;
    }


/* === PERBAIKAN HEADER STICKY TABEL === */
.table-responsive {
    position: relative;
    overflow: auto;
    max-height: calc(100vh - 220px); /* bisa sesuaikan tinggi area tampil */
    border: 2px solid #495057;
}

/* Pastikan header benar-benar sticky dan selalu di atas */
.table thead {
    position: sticky;
    top: 0;
    z-index: 1050; /* lebih tinggi dari elemen lain */
}

/* Header kolom */
.table thead th {
    position: sticky;
    top: 0;
    background-color: #0d6efd !important;
    color: white !important;
    font-weight: 600;
    text-align: center;
    z-index: 1060; /* pastikan paling atas */
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* biar terlihat terpisah */
}

</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

<!-- ================= HEADER ================= -->
<div class="row sticky-header align-items-center mb-3">
    <div class="col-8">
        <h2 class="mb-0">
            <i class="bi bi-table"></i> Data Billing - {{ username|upper }}
            {% if role == 'ULP' %}
                <span class="badge bg-primary">{{ unitup }}</span>
            {% elif unitup_filter %}
                <span class="badge bg-success">UP3</span>
                <span class="badge bg-info">UNITUP: {{ unitup_filter }}</span>
            {% else %}
                <span class="badge bg-success">UP3</span>
            {% endif %}
        </h2>
    </div>

    <div class="col-4 text-end">
        <div class="d-flex justify-content-end align-items-center gap-2">
            <!-- üîπ Tombol Download Data -->
            <button id="downloadExcelBtn" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Download Data
            </button>
            
            <!-- ‚úÖ Tombol Reset Filter (jika ada unitup_filter) -->
            {% if unitup_filter %}
            <a href="/view_billing" class="btn btn-outline-secondary" title="Lihat Semua Data">
                <i class="bi bi-x-circle"></i> Reset
            </a>
            {% endif %}
        </div>
    </div>
</div>


<!-- ================= FILTER CARD ================= -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end" id="filterForm">
            <input type="hidden" name="tab" value="{{ active_tab }}">
            <input type="hidden" name="page" value="1">
            
            <!-- ‚úÖ SIMPAN unitup_filter sebagai hidden input jika ada -->
            {% if unitup_filter %}
            <input type="hidden" name="unitup_filter" value="{{ unitup_filter }}">
            {% endif %}

            <!-- üîπ Periode -->
            <div class="col-2">
                <label class="form-label"><i class="bi bi-calendar3"></i> Periode</label>
                <select name="blth" id="blth" class="form-select" onchange="showLoading(); this.form.submit()">
                    <option value="">Pilih</option>
                    {% for blth in blth_list %}
                        <option value="{{ blth }}" {% if selected_blth == blth|string %}selected{% endif %}>{{ blth }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- üîπ Kelompok -->
            <div class="col-2">
                <label class="form-label"><i class="bi bi-tag"></i> KDKelompok</label>
                <select name="kdkelompok" class="form-select" onchange="showLoading(); this.form.submit()">
                    <option value="">Semua</option>
                    {% for i in range(1, 9) %}
                        <option value="{{ i }}" {% if selected_kelompok == i|string %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                    <option value="P" {% if selected_kelompok == 'P' %}selected{% endif %}>P</option>
                    <option value="A" {% if selected_kelompok == 'A' %}selected{% endif %}>A</option>
                    <option value="I" {% if selected_kelompok == 'I' %}selected{% endif %}>I</option>
                </select>
            </div>

            <!-- ‚úÖ Filter UNITUP hanya muncul untuk UP3 TANPA unitup_filter -->
            {% if role == 'UP3' and not unitup_filter %}
            <div class="col-2">
                <label class="form-label"><i class="bi bi-building"></i> UNITUP</label>
                <select name="unitup_filter" class="form-select" onchange="showLoading(); this.form.submit()">
                    <option value="">Semua</option>
                    {% for ulp in unitup_list %}
                        <option value="{{ ulp }}">{{ ulp }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- üîπ Jam Nyala - DINAMIS WIDTH -->
            <div class="col-{% if role == 'UP3' and not unitup_filter %}6{% else %}8{% endif %}">
                <label class="form-label"><i class="bi bi-clock"></i> Jam Nyala</label>
                <div class="input-group">
                    <input type="number" name="jam_nyala_min" class="form-control" 
                           value="{{ jam_nyala_min }}" placeholder="Min" step="0.1">
                    <span class="input-group-text">-</span>
                    <input type="number" name="jam_nyala_max" class="form-control" 
                           value="{{ jam_nyala_max }}" placeholder="Max" step="0.1">
                    <button type="submit" class="btn btn-primary" onclick="showLoading()">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- ================= DOWNLOAD HARI BACA ================= -->
<div class="card shadow-sm mb-4 border-success">
    <div class="card-body">
        <h6 class="fw-bold text-success mb-3">
            <i class="bi bi-download"></i> Download Data Berdasarkan Hari Baca (KDKELOMPOK)
        </h6>
        <form id="downloadHbForm" class="row g-2 align-items-center">
            <div class="col-auto">
                <label for="input1" class="col-form-label">Dari</label>
            </div>
            <div class="col-auto">
                <input type="text" class="form-control form-control-sm" id="input1" placeholder="" maxlength="1" required>
            </div>
            <div class="col-auto">
                <label for="input2" class="col-form-label">Sampai</label>
            </div>
            <div class="col-auto">
                <input type="text" class="form-control form-control-sm" id="input2" placeholder="" maxlength="1" required>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-success btn-sm" id="btnDownloadHb">
                    <i class="bi bi-file-earmark-excel"></i> Download Hari Baca
                </button>
            </div>
        </form>
    </div>
</div>
    <!-- Tabs -->
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'dlpd_3bln' %}active{% endif %}" data-tab="dlpd_3bln"
               href="?tab=dlpd_3bln&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-calendar3"></i> DLPD 3 Bln
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'naik' %}active{% endif %}" data-tab="naik"
               href="?tab=naik&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-arrow-up"></i> NAIK
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'turun' %}active{% endif %}" data-tab="turun"
               href="?tab=turun&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-arrow-down"></i> TURUN
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'div' %}active{% endif %}" data-tab="div"
               href="?tab=div&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-question"></i> DIV/NA
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'jam_nyala' %}active{% endif %}" data-tab="jam_nyala"
               href="?tab=jam_nyala&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1&jam_nyala_min={{ jam_nyala_min }}&jam_nyala_max={{ jam_nyala_max }}{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-clock"></i> Jam Nyala
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <div class="tab-pane fade {% if active_tab == 'dlpd_3bln' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="bi bi-bar-chart"></i> DLPD 3 Bulan (‚Üë50%) - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ dlpd_3bln_html|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'naik' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="bi bi-arrow-up"></i> Data NAIK - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ naik_html_v2|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'turun' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5><i class="bi bi-arrow-down"></i> Data TURUN - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ turun_html_v2|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'div' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="bi bi-question"></i> Data DIV/NA - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ div_html_v2|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'jam_nyala' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-clock"></i> Jam Nyala - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ jam_nyala_html|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ STATUS INDICATOR AUTO-SAVE -->
    <button id="saveVerifikasiBtn" class="btn btn-success btn-lg">
        <i class="bi bi-check-circle"></i> Auto-Save Aktif
    </button>
</div>
{% endblock %}

{% block extra_js %}
<script>

// ===== GLOBAL VARIABLES =====
let saveTimeout;
let saveQueue = 0;

// ===== UTILITY FUNCTIONS =====
function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.add('show');
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('show');
}

function open3Foto(idpel, blth) {
    const url = "https://portalapp.iconpln.co.id/acmt/DisplayBlobServlet1?idpel=";
    const getPrev = b => { 
        let y = +b.substr(0,4), m = +b.substr(4,2)-1; 
        if(!m){m=12;y--;} 
        return y+(m<10?'0'+m:m); 
    };
    const b1 = getPrev(blth), b2 = getPrev(b1);
    [blth, b1, b2].forEach((b,i) => window.open(`${url}${idpel}&blth=${b}`, `_f${i+1}`, `width=300,height=900,left=${10+310*i},top=10`));
}

// ===== AUTO-SAVE FUNCTIONS =====
function autoSaveVerifikasi(idpel, blth, field, value) {
    console.log('üíæ Attempting to save:', {idpel, blth, field, value});
    
    if (!idpel || !blth || !field) {
        console.error('‚ùå Missing required fields:', {idpel, blth, field});
        return;
    }
    
    // ‚úÖ FIX: Ambil UNITUP dari row yang sedang diedit
    const row = document.querySelector(`tr[data-idpel="${idpel}"][data-blth="${blth}"]`);
    let unitup = null;
    
    if (row) {
        // Coba ambil UNITUP dari kolom tabel (misal kolom ke-2)
        const cells = row.querySelectorAll('td');
        // Sesuaikan index dengan posisi kolom UNITUP di tabel Anda
        // Misal: BLTH (0), UNITUP (1), IDPEL (2), dst
        if (cells[1]) {
            unitup = cells[1].textContent.trim();
        }
    }
    
    console.log('üè¢ UNITUP detected:', unitup);
    
    saveQueue++;
    updateSaveStatus(true);
    
    fetch('/update_verifikasi_single', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            IDPEL: idpel,
            BLTH: blth,
            UNITUP: unitup,  // ‚úÖ Kirim UNITUP ke backend
            column: field,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        saveQueue--;
        if (data.success) {
            console.log('‚úÖ Auto-saved successfully!');
            showSaveSuccess();
        } else {
            console.error('‚ùå Save failed:', data.message);
            alert('‚ùå Gagal simpan: ' + data.message);
        }
        if (saveQueue === 0) {
            updateSaveStatus(false);
        }
    })
    .catch(error => {
        saveQueue--;
        console.error('‚ùå Network error:', error);
        alert('‚ùå Error jaringan: ' + error);
        if (saveQueue === 0) {
            updateSaveStatus(false);
        }
    });
}

function updateSaveStatus(saving) {
    const btn = document.getElementById('saveVerifikasiBtn');
    if (!btn) return;
    
    if (saving) {
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Menyimpan...';
        btn.classList.add('show');
        btn.disabled = true;
    } else {
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Tersimpan';
        setTimeout(() => {
            btn.classList.remove('show');
            btn.disabled = false;
        }, 2000);
    }
}

function showSaveSuccess() {
    console.log('‚úÖ Save success feedback shown');
}

// ===== WINDOW LOAD EVENT =====
window.addEventListener('load', function() {
    hideLoading();
});

// ===== MAIN DOM CONTENT LOADED =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing application...');
    
    // Debug URL parameters
    const params = new URLSearchParams(window.location.search);
    console.log('üìç Current URL params:');
    for (let [key, value] of params) {
        console.log(`  ${key} = ${value}`);
    }
    console.log('üî¢ Current rows_per_page:', params.get('rows_per_page') || 'not set');
    
    // ===== 1. ROW LIMIT SELECTOR =====
    const rowLimitSelect = document.getElementById('rowLimitSelect');
    if (rowLimitSelect) {
        console.log('‚úÖ Found rowLimitSelect');
        rowLimitSelect.addEventListener('change', function() {
            const newValue = this.value;
            console.log('üîÑ Changing rows per page to:', newValue);
            
            const url = new URL(window.location.href);
            url.searchParams.set('rows_per_page', newValue);
            url.searchParams.set('page', '1');
            
            console.log('üìç New URL:', url.toString());
            showLoading();
            window.location.href = url.toString();
        });
    } else {
        console.error('‚ùå rowLimitSelect not found!');
    }
    
    // ===== 3. AUTO-SELECT LATEST BLTH =====
    const blthSelect = document.getElementById("blth");
    if (blthSelect && !blthSelect.value && blthSelect.options.length > 1) {
        blthSelect.selectedIndex = 1;
        console.log('‚úÖ Auto-selected latest BLTH');
    }
    
    // ===== 4. FIX TEXTAREA & REMOVE \n =====
    document.querySelectorAll('textarea, .form-control').forEach(function(elem) {
        if (elem.value && elem.value.includes('\\n')) {
            elem.value = elem.value.replace(/\\n/g, ' ').trim();
        }
        
        if (elem.readOnly || elem.disabled) {
            elem.value = elem.value.replace(/\\n/g, ' ').replace(/\s+/g, ' ').trim();
        }
    });

    document.querySelectorAll('select option').forEach(function(option) {
        if (option.textContent.includes('\\n')) {
            option.textContent = option.textContent.replace(/\\n/g, ' ').trim();
        }
    });

    document.querySelectorAll('td, th, div, span').forEach(function(elem) {
        if (elem.innerHTML.includes('\\n')) {
            elem.innerHTML = elem.innerHTML.replace(/\\n/g, ' ').replace(/\s+/g, ' ').trim();
        }
    });
    
    // ===== 5. TRANSFORM CELLS TO INPUT FIELDS =====
    console.log('üîß Transforming cells to input fields...');
    
    document.querySelectorAll("table tbody tr").forEach((row, rowIdx) => {
        const cells = row.cells;
        
        const blth = cells[0]?.textContent.trim() || '';
        const idpel = cells[2]?.textContent.trim() || '';
        
        row.dataset.idpel = idpel;
        row.dataset.blth = blth;
        
        const table = row.closest('table');
        if (!table) return;
        
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        const hasilIdx = headers.indexOf('HASIL_PEMERIKSAAN');
        const stanIdx = headers.indexOf('STAN_VERIFIKASI');
        const tindakIdx = headers.indexOf('TINDAK_LANJUT');
        
        // Transform HASIL_PEMERIKSAAN
        if (hasilIdx >= 0 && cells[hasilIdx]) {
            const existingSelect = cells[hasilIdx].querySelector('select');
            let current = '';
            
            if (existingSelect) {
                current = existingSelect.value || '';
            } else {
                const val = cells[hasilIdx].textContent.trim();
                current = (val === 'NULL' || val === '-- Pilih --' || !val) ? '' : val;
            }
            
            const hasilOptions = [
                '', 'SESUAI', 'TEMPER NYALA', 'SALAH STAN', 'SALAH FOTO', 
                'FOTO BURAM', 'ANOMALI PDL', 'LEBIH TAGIH', 'KURANG TAGIH', 
                'BKN FOTO KWH', 'BENCANA', '3BLN TANPA STAN', 'BACA ULANG', 'MASUK 720JN'
            ];
            
            let html = '<select class="verifikasi-select" data-field="HASIL_PEMERIKSAAN">';
            hasilOptions.forEach(opt => {
                const selected = opt === current ? 'selected' : '';
                const display = opt === '' ? '-- Pilih --' : opt;
                html += `<option value="${opt}" ${selected}>${display}</option>`;
            });
            html += '</select>';
            
            cells[hasilIdx].innerHTML = html;
            
            const selectElement = cells[hasilIdx].querySelector('select');
            if (selectElement) {
                selectElement.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const idpel = row.dataset.idpel;
                    const blth = row.dataset.blth;
                    const value = this.value;
                    
                    row.classList.add('has-changes');
                    autoSaveVerifikasi(idpel, blth, 'HASIL_PEMERIKSAAN', value);
                });
            }
        }
        
        // Transform STAN_VERIFIKASI
        if (stanIdx >= 0 && cells[stanIdx]) {
            const existingInput = cells[stanIdx].querySelector('input');
            let current = '';
            
            if (existingInput) {
                current = existingInput.value || '';
            } else {
                const val = cells[stanIdx].textContent.trim();
                current = (val === 'NULL' || !val) ? '' : val;
            }
            
            cells[stanIdx].innerHTML = `<input type="number" class="verifikasi-input" data-field="STAN_VERIFIKASI" value="${current}" placeholder="Stan">`;
        }
        
        // Transform TINDAK_LANJUT
        if (tindakIdx >= 0 && cells[tindakIdx]) {
            const existingInput = cells[tindakIdx].querySelector('input');
            let current = '';
            
            if (existingInput) {
                current = existingInput.value || '';
            } else {
                const val = cells[tindakIdx].textContent.trim();
                current = (val === 'NULL' || !val) ? '' : val;
            }
            
            cells[tindakIdx].innerHTML = `<input type="text" class="verifikasi-input" data-field="TINDAK_LANJUT" value="${current}" placeholder="Tindak lanjut...">`;
        }
    });
    
    console.log('‚úÖ Cell transformation complete!');
    
    // ===== 6. SAHLWBP COLORING =====
    document.querySelectorAll("table").forEach(t => {
        const headers = Array.from(t.querySelectorAll("thead th"));
        const idx = headers.findIndex(h => h.innerText.trim().toUpperCase() === "SAHLWBP");
        
        if (idx !== -1) {
            headers[idx].classList.add("sahlwbp-header");
            t.querySelectorAll("tbody tr").forEach(r => {
                const c = r.cells[idx];
                if (c) {
                    const value = parseFloat(c.innerText.replace(',','.'));
                    c.classList.add(value > 0 ? "sahlwbp-cell-blue-positive" : "sahlwbp-cell-blue");
                }
            });
        }
    });
    
    console.log('‚úÖ Application initialized successfully!');
});

// ===== 7. EVENT DELEGATION FOR INPUT FIELDS =====
document.addEventListener('input', function(e) {
    // TINDAK_LANJUT input (debounced)
    if (e.target.classList.contains('verifikasi-input') && e.target.dataset.field === 'TINDAK_LANJUT') {
        const row = e.target.closest('tr');
        if (!row) return;
        
        const idpel = row.dataset.idpel;
        const blth = row.dataset.blth;
        const field = e.target.dataset.field;
        const value = e.target.value;
        
        row.classList.add('has-changes');
        
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            autoSaveVerifikasi(idpel, blth, field, value);
        }, 1000);
    }
});

// Blur event for STAN_VERIFIKASI
document.addEventListener('blur', function(e) {
    if (e.target.classList.contains('verifikasi-input') && e.target.dataset.field === 'STAN_VERIFIKASI') {
        const row = e.target.closest('tr');
        if (!row) return;
        
        const idpel = row.dataset.idpel;
        const blth = row.dataset.blth;
        const field = e.target.dataset.field;
        const value = e.target.value;
        
        row.classList.add('has-changes');
        autoSaveVerifikasi(idpel, blth, field, value);
    }
}, true);


// ===== DOWNLOAD EXCEL BUTTON - FIXED VERSION =====
document.addEventListener('DOMContentLoaded', function() {
    const downloadBtn = document.getElementById("downloadExcelBtn");
    
    if (!downloadBtn) {
        console.error('‚ùå downloadExcelBtn not found!');
        return;
    }
    
    console.log('‚úÖ Download button found and initialized');
    
    downloadBtn.addEventListener("click", function(e) {
        e.preventDefault(); // Prevent default behavior
        console.log('üì• Download Excel clicked');
        
        // Ambil tab aktif
        const activeTabLink = document.querySelector(".nav-link.active");
        if (!activeTabLink) {
            alert("‚ùå Pilih tab terlebih dahulu");
            return;
        }
        
        const tabName = activeTabLink.dataset.tab || activeTabLink.getAttribute('data-tab');
        console.log('üìÇ Active tab:', tabName);
        
        if (!tabName) {
            alert("‚ùå Tab tidak ditemukan");
            return;
        }
        
        // Ambil parameter dari URL saat ini
        const currentParams = new URLSearchParams(window.location.search);
        
        // Buat URL download
        const downloadUrl = new URL(window.location.origin + "/download_excel");
        downloadUrl.searchParams.set("tab", tabName);
        
        // Copy parameter filter yang ada
        const filterParams = ["blth", "kdkelompok", "unitup_filter", "jam_nyala_min", "jam_nyala_max"];
        filterParams.forEach(param => {
            const value = currentParams.get(param);
            if (value) {
                downloadUrl.searchParams.set(param, value);
            }
        });
        
        console.log('üîó Download URL:', downloadUrl.toString());
        
        // Update button state
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
        this.disabled = true;
        
        // Trigger download
        window.location.href = downloadUrl.toString();
        
        // Reset button after delay
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-file-earmark-excel"></i> Excel';
            this.disabled = false;
        }, 3000);
    });
});


// ===== 3. HIGHLIGHT BARIS SAAT DIKLIK =====
document.addEventListener("DOMContentLoaded", function () {
    const tableContainers = document.querySelectorAll(".table-responsive table");

    tableContainers.forEach(table => {
        table.addEventListener("click", function (event) {
            const row = event.target.closest("tr");
            if (!row) return;

            // Hilangkan highlight di semua baris lain
            table.querySelectorAll("tr.active-row").forEach(r => r.classList.remove("active-row"));

            // Tambahkan highlight pada baris yang diklik
            row.classList.add("active-row");
        });
    });
});



// ===== TABLE SORTING FUNCTIONALITY =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÄ Initializing table sorting...');
    
    // Function to make table sortable
    function makeSortable(table) {
        const headers = table.querySelectorAll('thead th');
        const tbody = table.querySelector('tbody');
        
        if (!tbody) return;
        
        headers.forEach((header, columnIndex) => {
            // Skip if header is empty or contains action buttons
            const headerText = header.textContent.trim();
            if (!headerText || headerText === 'AKSI' || headerText === 'FOTO') {
                return;
            }
            
            // Add sortable class
            header.classList.add('sortable');
            header.dataset.column = columnIndex;
            header.dataset.sortType = 'none'; // none, asc, desc
            
            // Add click event
            header.addEventListener('click', function(e) {
                // Don't sort if clicking on input/select inside header
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                sortTable(table, columnIndex, this);
            });
        });
        
        console.log(`‚úÖ Made table sortable with ${headers.length} columns`);
    }
    
    // Function to sort table
    function sortTable(table, columnIndex, header) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Determine sort direction
        let sortType = header.dataset.sortType || 'none';
        let newSortType = 'asc';
        
        if (sortType === 'none') {
            newSortType = 'asc';
        } else if (sortType === 'asc') {
            newSortType = 'desc';
        } else {
            newSortType = 'asc';
        }
        
        console.log(`üîÄ Sorting column ${columnIndex} - ${newSortType}`);
        
        // Remove sort classes from all headers
        table.querySelectorAll('thead th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc', 'sorted');
            th.dataset.sortType = 'none';
        });
        
        // Remove sorted-column class from all cells
        table.querySelectorAll('td').forEach(td => {
            td.classList.remove('sorted-column');
        });
        
        // Add sort class to current header
        header.classList.add(newSortType === 'asc' ? 'sort-asc' : 'sort-desc');
        header.classList.add('sorted');
        header.dataset.sortType = newSortType;
        
        // Sort rows
        rows.sort((a, b) => {
            let aCell = a.cells[columnIndex];
            let bCell = b.cells[columnIndex];
            
            if (!aCell || !bCell) return 0;
            
            // Get cell value (handle inputs/selects)
            let aValue = getCellValue(aCell);
            let bValue = getCellValue(bCell);
            
            // Determine if numeric
            let aNum = parseFloat(aValue.replace(/,/g, '.'));
            let bNum = parseFloat(bValue.replace(/,/g, '.'));
            
            let result = 0;
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
                // Numeric comparison
                result = aNum - bNum;
            } else {
                // String comparison
                result = aValue.localeCompare(bValue, 'id', {numeric: true});
            }
            
            return newSortType === 'asc' ? result : -result;
        });
        
        // Re-append rows in sorted order
        rows.forEach(row => tbody.appendChild(row));
        
        // Highlight sorted column
        rows.forEach(row => {
            if (row.cells[columnIndex]) {
                row.cells[columnIndex].classList.add('sorted-column');
            }
        });
        
        console.log(`‚úÖ Sorted ${rows.length} rows`);
        
        // Update zebra striping
        updateZebraStriping(tbody);
    }
    
    // Function to get cell value
    function getCellValue(cell) {
        // Check for input
        const input = cell.querySelector('input');
        if (input) return input.value || '';
        
        // Check for select
        const select = cell.querySelector('select');
        if (select) return select.value || select.textContent || '';
        
        // Return text content
        return cell.textContent.trim();
    }
    
    // Function to update zebra striping after sort
    function updateZebraStriping(tbody) {
        const rows = tbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            // Remove existing even class
            row.classList.remove('even-row');
            // Add class based on new position
            if (index % 2 === 1) {
                row.classList.add('even-row');
            }
        });
    }
    
    // Initialize sorting for all tables
    const tables = document.querySelectorAll('.table-responsive table');
    tables.forEach(table => {
        makeSortable(table);
    });
    
    console.log('‚úÖ Table sorting initialized!');
});
// ===== FIXED: JavaScript untuk Download Hari Baca - VERSION 3 (DENGAN TAB FILTER) =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Download Hari Baca...');
    
    const btnDownloadHb = document.getElementById('btnDownloadHb');
    
    if (!btnDownloadHb) {
        console.error('‚ùå Button #btnDownloadHb not found!');
        return;
    }
    
    console.log('‚úÖ Download Hari Baca button found');
    
    btnDownloadHb.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üì• Download Hari Baca button clicked!');
        
        // ‚úÖ Ambil tab aktif
        const activeTabLink = document.querySelector('.nav-link.active');
        if (!activeTabLink) {
            alert('‚ùå Pilih tab terlebih dahulu (NAIK/TURUN/DLPD/DIV/JAM_NYALA)');
            return;
        }
        
        const activeTab = activeTabLink.dataset.tab || activeTabLink.getAttribute('data-tab');
        console.log('üìÇ Active tab:', activeTab);
        
        // Ambil BLTH dari filter utama
        const mainBlthSelect = document.getElementById('blth');
        const input1Field = document.getElementById('input1');
        const input2Field = document.getElementById('input2');
        
        if (!mainBlthSelect || !input1Field || !input2Field) {
            console.error('‚ùå Form fields not found!');
            alert('‚ùå Error: Form fields tidak ditemukan');
            return;
        }
        
        const blth = mainBlthSelect.value.trim();
        const input1 = input1Field.value.trim().toUpperCase();
        const input2 = input2Field.value.trim().toUpperCase();
        
        console.log('üìã Form values:', {activeTab, blth, input1, input2});
        
        // Validasi BLTH
        if (!blth) {
            alert('‚ö†Ô∏è Pilih periode (BLTH) terlebih dahulu dari filter utama!');
            mainBlthSelect.focus();
            return;
        }
        
        // Validasi input1 dan input2
        if (!input1 || !input2) {
            alert('‚ö†Ô∏è Isi range kelompok (Dari - Sampai)!');
            if (!input1) input1Field.focus();
            else input2Field.focus();
            return;
        }
        
        // Validasi karakter valid
        const validChars = ['1', '2', '3', '4', '5', '6', '7', '8', 'P', 'A', 'I'];
        if (!validChars.includes(input1)) {
            alert('‚ö†Ô∏è "Dari Kelompok" harus: 1-8, P, A, atau I\nAnda input: ' + input1);
            input1Field.focus();
            return;
        }
        
        if (!validChars.includes(input2)) {
            alert('‚ö†Ô∏è "Sampai Kelompok" harus: 1-8, P, A, atau I\nAnda input: ' + input2);
            input2Field.focus();
            return;
        }
        
        console.log('‚úÖ Validation passed');
        
        // ‚úÖ Build URL dengan TAB parameter
        const url = new URL(window.location.origin + "/download_excel_hb");
        url.searchParams.set('tab', activeTab);      // ‚≠ê TAMBAHAN INI
        url.searchParams.set('blth', blth);
        url.searchParams.set('input1', input1);
        url.searchParams.set('input2', input2);
        
        console.log('üîó Download URL:', url.toString());
        
        // Update button state
        const originalHTML = this.innerHTML;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
        this.disabled = true;
        
        // Trigger download
        window.location.href = url.toString();
        
        // Reset button
        setTimeout(() => {
            this.innerHTML = originalHTML;
            this.disabled = false;
            console.log('‚úÖ Download triggered successfully!');
        }, 3000);
    });
    
    console.log('‚úÖ Download Hari Baca initialized!');
});







// ===== FIXED: JavaScript untuk Download Hari Baca dengan UNITUP Filter =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Download Hari Baca with UNITUP filter...');
    
    const btnDownloadHb = document.getElementById('btnDownloadHb');
    
    if (!btnDownloadHb) {
        console.error('‚ùå Button #btnDownloadHb not found!');
        return;
    }
    
    console.log('‚úÖ Download Hari Baca button found');
    
    btnDownloadHb.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üì• Download Hari Baca button clicked!');
        
        // ‚úÖ Ambil tab aktif
        const activeTabLink = document.querySelector('.nav-link.active');
        if (!activeTabLink) {
            alert('‚ùå Pilih tab terlebih dahulu (NAIK/TURUN/DLPD/DIV/JAM_NYALA)');
            return;
        }
        
        const activeTab = activeTabLink.dataset.tab || activeTabLink.getAttribute('data-tab');
        console.log('üìÇ Active tab:', activeTab);
        
        // Ambil BLTH dari filter utama
        const mainBlthSelect = document.getElementById('blth');
        const input1Field = document.getElementById('input1');
        const input2Field = document.getElementById('input2');
        
        if (!mainBlthSelect || !input1Field || !input2Field) {
            console.error('‚ùå Form fields not found!');
            alert('‚ùå Error: Form fields tidak ditemukan');
            return;
        }
        
        const blth = mainBlthSelect.value.trim();
        const input1 = input1Field.value.trim().toUpperCase();
        const input2 = input2Field.value.trim().toUpperCase();
        
        console.log('üìã Form values:', {activeTab, blth, input1, input2});
        
        // Validasi BLTH
        if (!blth) {
            alert('‚ö†Ô∏è Pilih periode (BLTH) terlebih dahulu dari filter utama!');
            mainBlthSelect.focus();
            return;
        }
        
        // Validasi input1 dan input2
        if (!input1 || !input2) {
            alert('‚ö†Ô∏è Isi range kelompok (Dari - Sampai)!');
            if (!input1) input1Field.focus();
            else input2Field.focus();
            return;
        }
        
        // Validasi karakter valid
        const validChars = ['1', '2', '3', '4', '5', '6', '7', '8', 'P', 'A', 'I'];
        if (!validChars.includes(input1)) {
            alert('‚ö†Ô∏è "Dari Kelompok" harus: 1-8, P, A, atau I\nAnda input: ' + input1);
            input1Field.focus();
            return;
        }
        
        if (!validChars.includes(input2)) {
            alert('‚ö†Ô∏è "Sampai Kelompok" harus: 1-8, P, A, atau I\nAnda input: ' + input2);
            input2Field.focus();
            return;
        }
        
        console.log('‚úÖ Validation passed');
        
        // ‚≠ê PERBAIKAN: Ambil UNITUP dari checkbox (BUKAN dari dropdown)
        const unitupCheckboxes = document.querySelectorAll('input[name="unitup_filter"]:checked');
        const selectedUnitups = Array.from(unitupCheckboxes)
            .map(cb => cb.value)
            .filter(val => val && val.toLowerCase() !== 'semua'); // Exclude "Semua"
        
        console.log('üè¢ Selected UNITUPs from checkboxes:', selectedUnitups);
        
        // ‚≠ê ALTERNATIF: Jika menggunakan dropdown multi-select
        const unitupSelect = document.querySelector('select[name="unitup_filter"]');
        if (unitupSelect && unitupSelect.multiple) {
            const selectedOptions = Array.from(unitupSelect.selectedOptions)
                .map(opt => opt.value)
                .filter(val => val && val.toLowerCase() !== 'semua');
            selectedUnitups.push(...selectedOptions);
        }
        
        // ‚≠ê ALTERNATIF 2: Jika menggunakan dropdown biasa
        if (unitupSelect && !unitupSelect.multiple) {
            const singleValue = unitupSelect.value;
            if (singleValue && singleValue.toLowerCase() !== 'semua') {
                selectedUnitups.push(singleValue);
            }
        }
        
        console.log('üè¢ Final selected UNITUPs:', selectedUnitups);
        
        // Validasi UNITUP (opsional - untuk UP3 wajib pilih)
        if (selectedUnitups.length === 0) {
            // Cek apakah user adalah UP3
            const userRole = document.body.dataset.userRole || ''; // Asumsikan role ada di body
            if (userRole.toUpperCase() === 'UP3') {
                alert('‚ö†Ô∏è Pilih minimal 1 UNITUP dari checkbox!');
                return;
            }
        }
        
        // ‚úÖ Build URL dengan TAB dan UNITUP parameter
        const url = new URL(window.location.origin + "/download_excel_hb");
        url.searchParams.set('tab', activeTab);
        url.searchParams.set('blth', blth);
        url.searchParams.set('input1', input1);
        url.searchParams.set('input2', input2);
        
        // ‚≠ê PERBAIKAN KRUSIAL: Kirim SEMUA UNITUP yang dipilih
        selectedUnitups.forEach(unitup => {
            url.searchParams.append('unitup_filter', unitup); // Gunakan append, bukan set
        });
        
        console.log('üîó Download URL:', url.toString());
        console.log('üì¶ URL params breakdown:');
        for (let [key, value] of url.searchParams.entries()) {
            console.log(`  ${key} = ${value}`);
        }
        
        // Update button state
        const originalHTML = this.innerHTML;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
        this.disabled = true;
        
        // Trigger download
        window.location.href = url.toString();
        
        // Reset button
        setTimeout(() => {
            this.innerHTML = originalHTML;
            this.disabled = false;
            console.log('‚úÖ Download triggered successfully!');
        }, 3000);
    });
    
    console.log('‚úÖ Download Hari Baca with UNITUP filter initialized!');
});


// ===== BONUS: Auto-sync Checkbox dengan Dropdown (jika ada keduanya) =====
document.addEventListener('DOMContentLoaded', function() {
    // Sinkronisasi checkbox UNITUP dengan dropdown
    const unitupCheckboxes = document.querySelectorAll('input[name="unitup_filter"]');
    const unitupDropdown = document.querySelector('select[name="unitup_filter"]');
    
    if (unitupCheckboxes.length > 0 && unitupDropdown) {
        console.log('üîó Syncing UNITUP checkbox with dropdown...');
        
        // Ketika checkbox berubah, update dropdown
        unitupCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkedValues = Array.from(document.querySelectorAll('input[name="unitup_filter"]:checked'))
                    .map(cb => cb.value);
                
                console.log('üìã Checked UNITUPs:', checkedValues);
                
                // Update dropdown selection
                if (unitupDropdown.multiple) {
                    Array.from(unitupDropdown.options).forEach(option => {
                        option.selected = checkedValues.includes(option.value);
                    });
                } else {
                    // Single select - pilih yang pertama atau "Semua"
                    if (checkedValues.length === 1) {
                        unitupDropdown.value = checkedValues[0];
                    } else if (checkedValues.length === 0) {
                        unitupDropdown.value = 'Semua';
                    }
                }
                
                // Trigger reload tabel jika ada
                const filterBtn = document.querySelector('button[type="submit"]');
                if (filterBtn && checkedValues.length > 0) {
                    console.log('üîÑ Auto-submitting filter...');
                    filterBtn.click();
                }
            });
        });
        
        console.log('‚úÖ UNITUP checkbox-dropdown sync initialized!');
    }
});


// ===== BONUS: Handle "Select All" Checkbox =====
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.querySelector('input[value="Semua"], input[value="(Select All)"]');
    const unitupCheckboxes = document.querySelectorAll('input[name="unitup_filter"]:not([value="Semua"]):not([value="(Select All)"])');
    
    if (selectAllCheckbox && unitupCheckboxes.length > 0) {
        console.log('‚úÖ Found "Select All" checkbox');
        
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            console.log(`${isChecked ? '‚úÖ' : '‚ùå'} Select All ${isChecked ? 'checked' : 'unchecked'}`);
            
            unitupCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            // Trigger change event on first checkbox to sync
            if (unitupCheckboxes.length > 0) {
                unitupCheckboxes[0].dispatchEvent(new Event('change'));
            }
        });
        
        // Update "Select All" state when individual checkboxes change
        unitupCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const allChecked = Array.from(unitupCheckboxes).every(cb => cb.checked);
                const noneChecked = Array.from(unitupCheckboxes).every(cb => !cb.checked);
                
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (noneChecked) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true; // Partial selection
                }
            });
        });
        
        console.log('‚úÖ "Select All" functionality initialized!');
    }
});




document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing application...');
    
    // ‚úÖ AUTO-FILTER: Hapus parameter setelah load pertama
    const urlParams = new URLSearchParams(window.location.search);
    const autoFilter = urlParams.get('auto_filter');
    
    if (autoFilter === '1') {
        console.log('üîç AUTO-FILTER MODE DETECTED!');
        console.log('üìç Filters applied:', {
            unitup: urlParams.get('unitup_filter'),
            blth: urlParams.get('blth'),
            tab: urlParams.get('tab')
        });
        
        // Hapus parameter auto_filter dari URL
        urlParams.delete('auto_filter');
        const newUrl = window.location.pathname + '?' + urlParams.toString();
        window.history.replaceState({}, '', newUrl);
        
        console.log('‚úÖ Auto-filter applied, URL cleaned');
    }
    
    // ... rest of your existing code
});







</script>
{% endblock %}