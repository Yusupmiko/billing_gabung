{% extends "base.html" %}

{% block title %}Data Billing - SnapBill{% endblock %}

{% block extra_css %}
<style>
    body { font-size: 11px !important; }
    
    .sticky-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 6px 0 !important;
        margin-bottom: 6px !important;
    }
    
    .sticky-header h2 {
        font-size: 1.1rem;
        margin: 0;
        line-height: 1.2;
    }
    
    .sticky-header .badge {
        font-size: 0.7rem;
        padding: 3px 6px;
    }
    
    .card {
        margin-bottom: 6px;
        border: 1px solid #dee2e6;
    }
    
    .card-body {
        padding: 8px;
    }
    
    .card-header {
        padding: 5px 8px;
        font-size: 0.9rem;
    }
    
    .card-header h5 {
        font-size: 0.9rem;
        margin: 0;
        font-weight: 600;
    }
    
    .row.g-3 {
        row-gap: 6px !important;
    }
    
    .form-label {
        margin-bottom: 2px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .form-select, .form-control {
        font-size: 0.75rem;
        padding: 3px 6px;
        height: 26px;
    }
    
    textarea.form-control {
        height: auto !important;
    }
    
    .btn {
        padding: 3px 10px;
        font-size: 0.75rem;
        line-height: 1.3;
    }
    
    .input-group-text {
        padding: 3px 6px;
        font-size: 0.75rem;
    }
    
    .nav-tabs {
        margin-bottom: 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
        padding: 4px 10px;
        font-size: 0.75rem;
        border-radius: 3px 3px 0 0;
        margin-right: 2px;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #0d6efd;
        color: white !important;
        font-weight: 600;
    }
    
    .nav-tabs .nav-link:not(.active) {
        background-color: #f1f3f5;
    }
    
 /* ‚≠ê UPDATE: Table Responsive dengan Sticky Header */
    .table-responsive {
        font-size: 0.7rem;
        max-height: calc(100vh - 320px);
        overflow: auto;
        border: 2px solid #495057;
        position: relative; /* ‚≠ê TAMBAH INI */
    }
    
    table {
        margin-bottom: 0;
        width: 100%;
        border-collapse: separate; /* ‚≠ê UBAH dari collapse ke separate */
        border-spacing: 0; /* ‚≠ê TAMBAH INI */
        border: 1px solid #495057;
    }
    
    /* ‚≠ê UPDATE: Sticky Header yang Lebih Kuat */
    table thead th {
        position: -webkit-sticky; /* ‚≠ê TAMBAH untuk Safari */
        position: sticky;
        top: 0; /* ‚≠ê Pastikan ini ada */
        background: #0d6efd;
        color: white;
        font-weight: 600;
        padding: 4px 6px;
        white-space: nowrap;
        font-size: 0.7rem;
        border: 1px solid #fff;
        border-right: 1px solid #0a58ca;
        border-bottom: 2px solid #0a58ca;
        z-index: 100; /* ‚≠ê UBAH dari 10 ke 100 */
        line-height: 1.2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* ‚≠ê TAMBAH shadow */
    }
    
    /* ‚≠ê TAMBAH: Pastikan header tetap di atas saat sorting */
    table thead th.sorted {
        background-color: #0a58ca !important;
        z-index: 101; /* ‚≠ê Lebih tinggi dari header lain */
    }
    
    table tbody td {
        padding: 3px 6px;
        vertical-align: middle;
        border: 1px solid #ced4da;
        border-right: 1px solid #adb5bd;
        border-bottom: 1px solid #adb5bd;
        white-space: nowrap;
        line-height: 1.2;
        background-color: white; /* ‚≠ê TAMBAH explicit background */
    }
    
    table tbody tr:nth-child(even) td {
        background-color: #f8f9fa;
    }
    
    table tbody tr:hover td {
        background-color: #e7f1ff !important;
        cursor: pointer;
    }

    /* ... CSS lainnya tetap sama ... */
    
    /* ‚≠ê UPDATE: Sorting Icons - pastikan tidak menutupi teks header */
    table thead th {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 24px !important; /* ‚≠ê UBAH dari 20px ke 24px */
    }
    
    table thead th.sortable::after {
        content: "‚áÖ";
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%); /* ‚≠ê TAMBAH untuk center vertikal */
        opacity: 0.3;
        font-size: 0.8rem;
    }
    
    table thead th.sortable:hover::after {
        opacity: 0.6;
    }
    
    table thead th.sort-asc::after {
        content: "‚ñ≤";
        opacity: 1;
        color: #ffd700;
    }
    
    table thead th.sort-desc::after {
        content: "‚ñº";
        opacity: 1;
        color: #ffd700;
    }


    .highlight {
        background-color: #90EE90 !important;
        font-weight: 600;
    }
    
    .sahlwbp-header {
        background-color: #0a58ca !important;
    }
    
    .sahlwbp-cell-blue {
        background-color: #e7f1ff !important;
    }
    
    .sahlwbp-cell-blue-positive {
        background-color: #cfe2ff !important;
        font-weight: 600;
    }
    
    .table-responsive::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .bi {
        font-size: 0.8rem;
    }
    
    .pagination {
        margin: 8px 0;
        justify-content: center;
    }
    
    .pagination .page-link {
        padding: 3px 8px;
        font-size: 0.75rem;
        margin: 0 2px;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .loading-overlay.show {
        display: flex;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d6efd;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .row-limit-selector {
        display: inline-block;
        margin-left: 10px;
    }
    
    .row-limit-selector select {
        width: auto;
        display: inline-block;
    }
    
    /* Tombol Simpan Verifikasi Sticky */
    #saveVerifikasiBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        padding: 10px 20px;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
    }
    
    #saveVerifikasiBtn.show {
        display: block;
        animation: bounceIn 0.4s ease-out;
    }
    
    @keyframes bounceIn {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* Input di tabel untuk verifikasi */
    .verifikasi-input {
        font-size: 0.7rem;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        width: 100%;
        background: #fffacd;
    }
    
    .verifikasi-input:focus {
        background: white;
        border-color: #0d6efd;
        outline: none;
    }
    
    .verifikasi-select {
        font-size: 0.7rem;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        width: 100%;
        background: #fffacd;
    }
    
    .verifikasi-select:focus {
        background: white;
        border-color: #0d6efd;
    }
    
    .verifikasi-textarea {
        font-size: 0.7rem;
        padding: 2px 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        width: 100%;
        min-height: 40px;
        resize: vertical;
        background: #fffacd;
    }
    
    .verifikasi-textarea:focus {
        background: white;
        border-color: #0d6efd;
        outline: none;
    }
    
    /* Badge untuk menandai ada perubahan */
    .has-changes {
        background-color: #fff3cd !important;
        border-left: 3px solid #ffc107;
    }


table tbody tr.active-row,
table.dataTable tbody tr.active-row {
    background-color: #d8f3dc !important; /* hijau muda lembut */
    color: #1b4332 !important;            /* teks hijau tua */
    font-weight: 600 !important;
    transition: background-color 0.3s ease, color 0.3s ease;
    border-left: 4px solid #40916c !important; /* garis kiri lembut */
}

/* Hover state untuk baris aktif */
table tbody tr.active-row:hover,
table.dataTable tbody tr.active-row:hover {
    background-color: #b7e4c7 !important; /* sedikit lebih gelap saat hover */
}

/* Pastikan cell di dalam baris aktif ikut berubah */
table tbody tr.active-row td,
table.dataTable tbody tr.active-row td {
    background-color: inherit !important;
    color: inherit !important;
}

 /* Sorting Icons */
    table thead th {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
    }
    
    table thead th.sortable::after {
        content: "‚áÖ";
        position: absolute;
        right: 6px;
        opacity: 0.3;
        font-size: 0.8rem;
    }
    
    table thead th.sortable:hover::after {
        opacity: 0.6;
    }
    
    table thead th.sort-asc::after {
        content: "‚ñ≤";
        opacity: 1;
        color: #ffd700;
    }
    
    table thead th.sort-desc::after {
        content: "‚ñº";
        opacity: 1;
        color: #ffd700;
    }
    
    /* Highlight sorted column */
    table thead th.sorted {
        background-color: #0a58ca !important;
    }
    
    table tbody td.sorted-column {
        background-color: #f0f8ff !important;
    }
    
    table tbody tr:nth-child(even) td.sorted-column {
        background-color: #e6f2ff !important;
    }
    
    table tbody tr.active-row td.sorted-column {
        background-color: inherit !important;
    }


/* === PERBAIKAN HEADER STICKY TABEL === */
.table-responsive {
    position: relative;
    overflow: auto;
    max-height: calc(100vh - 220px); /* bisa sesuaikan tinggi area tampil */
    border: 2px solid #495057;
}

/* Pastikan header benar-benar sticky dan selalu di atas */
.table thead {
    position: sticky;
    top: 0;
    z-index: 1050; /* lebih tinggi dari elemen lain */
}

/* Header kolom */
.table thead th {
    position: sticky;
    top: 0;
    background-color: #0d6efd !important;
    color: white !important;
    font-weight: 600;
    text-align: center;
    z-index: 1060; /* pastikan paling atas */
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* biar terlihat terpisah */
}

/* Grafik Canvas Container */
#grafikContent {
    min-height: 400px;
    height: 400px;
    position: relative;
    padding: 10px;
}

#grafikChart {
    max-height: 400px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

<!-- ================= HEADER ================= -->
<div class="row sticky-header align-items-center mb-3">
    <div class="col-8">
        <h2 class="mb-0">
            <i class="bi bi-table"></i> Data Billing - {{ username|upper }}
            {% if role == 'ULP' %}
                <span class="badge bg-primary">{{ unitup }}</span>
            {% elif unitup_filter %}
                <span class="badge bg-success">UP3</span>
                <span class="badge bg-info">UNITUP: {{ unitup_filter }}</span>
            {% else %}
                <span class="badge bg-success">UP3</span>
            {% endif %}
        </h2>
    </div>

    <div class="col-4 text-end">
        <div class="d-flex justify-content-end align-items-center gap-2">
            <!-- üîπ Tombol Download Data -->
            <button id="downloadExcelBtn" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Download Data
            </button>
            
            <!-- ‚úÖ Tombol Reset Filter (jika ada unitup_filter) -->
            {% if unitup_filter %}
            <a href="/view_billing" class="btn btn-outline-secondary" title="Lihat Semua Data">
                <i class="bi bi-x-circle"></i> Reset
            </a>
            {% endif %}
        </div>
    </div>
</div>


<!-- ================= FILTER CARD ================= -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end" id="filterForm">
            <input type="hidden" name="tab" value="{{ active_tab }}">
            <input type="hidden" name="page" value="1">
            
            <!-- ‚úÖ SIMPAN unitup_filter sebagai hidden input jika ada -->
            {% if unitup_filter %}
            <input type="hidden" name="unitup_filter" value="{{ unitup_filter }}">
            {% endif %}

            <!-- üîπ Periode -->
            <div class="col-2">
                <label class="form-label"><i class="bi bi-calendar3"></i> Periode</label>
                <select name="blth" id="blth" class="form-select" onchange="showLoading(); this.form.submit()">
                    <option value="">Pilih</option>
                    {% for blth in blth_list %}
                        <option value="{{ blth }}" {% if selected_blth == blth|string %}selected{% endif %}>{{ blth }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- üîπ Kelompok -->
            <div class="col-2">
                <label class="form-label"><i class="bi bi-tag"></i> KDKelompok</label>
                <select name="kdkelompok" class="form-select" onchange="showLoading(); this.form.submit()">
                    <option value="">Semua</option>
                    {% for i in range(1, 9) %}
                        <option value="{{ i }}" {% if selected_kelompok == i|string %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                    <option value="P" {% if selected_kelompok == 'P' %}selected{% endif %}>P</option>
                    <option value="A" {% if selected_kelompok == 'A' %}selected{% endif %}>A</option>
                    <option value="I" {% if selected_kelompok == 'I' %}selected{% endif %}>I</option>
                </select>
            </div>

            <!-- ‚úÖ Filter UNITUP hanya muncul untuk UP3 TANPA unitup_filter -->
            {% if role == 'UP3' and not unitup_filter %}
            <div class="col-2">
                <label class="form-label"><i class="bi bi-building"></i> UNITUP</label>
                <select name="unitup_filter" class="form-select" onchange="showLoading(); this.form.submit()">
                    <option value="">Semua</option>
                    {% for ulp in unitup_list %}
                        <option value="{{ ulp }}">{{ ulp }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- üîπ Jam Nyala - DINAMIS WIDTH -->
            <div class="col-{% if role == 'UP3' and not unitup_filter %}6{% else %}8{% endif %}">
                <label class="form-label"><i class="bi bi-clock"></i> Jam Nyala</label>
                <div class="input-group">
                    <input type="number" name="jam_nyala_min" class="form-control" 
                           value="{{ jam_nyala_min }}" placeholder="Min" step="0.1">
                    <span class="input-group-text">-</span>
                    <input type="number" name="jam_nyala_max" class="form-control" 
                           value="{{ jam_nyala_max }}" placeholder="Max" step="0.1">
                    <button type="submit" class="btn btn-primary" onclick="showLoading()">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- ================= DOWNLOAD HARI BACA ================= -->
<div class="card shadow-sm mb-4 border-success">
    <div class="card-body">
        <h6 class="fw-bold text-success mb-3">
            <i class="bi bi-download"></i> Download Data Berdasarkan Hari Baca (KDKELOMPOK)
        </h6>
        <form id="downloadHbForm" class="row g-2 align-items-center">
            <div class="col-auto">
                <label for="input1" class="col-form-label">Dari</label>
            </div>
            <div class="col-auto">
                <input type="text" class="form-control form-control-sm" id="input1" placeholder="" maxlength="1" required>
            </div>
            <div class="col-auto">
                <label for="input2" class="col-form-label">Sampai</label>
            </div>
            <div class="col-auto">
                <input type="text" class="form-control form-control-sm" id="input2" placeholder="" maxlength="1" required>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-success btn-sm" id="btnDownloadHb">
                    <i class="bi bi-file-earmark-excel"></i> Download Hari Baca
                </button>
            </div>
        </form>
    </div>
</div>
    <!-- Tabs -->
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'dlpd_3bln' %}active{% endif %}" data-tab="dlpd_3bln"
               href="?tab=dlpd_3bln&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-calendar3"></i> DLPD 3 Bln
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'naik' %}active{% endif %}" data-tab="naik"
               href="?tab=naik&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-arrow-up"></i> NAIK
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'turun' %}active{% endif %}" data-tab="turun"
               href="?tab=turun&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-arrow-down"></i> TURUN
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'div' %}active{% endif %}" data-tab="div"
               href="?tab=div&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-question"></i> DIV/NA
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'jam_nyala' %}active{% endif %}" data-tab="jam_nyala"
               href="?tab=jam_nyala&blth={{ selected_blth }}&kdkelompok={{ selected_kelompok }}&page=1&jam_nyala_min={{ jam_nyala_min }}&jam_nyala_max={{ jam_nyala_max }}{% if unitup_filter %}&unitup_filter={{ unitup_filter }}{% endif %}"
               onclick="showLoading()">
                <i class="bi bi-clock"></i> Jam Nyala
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <div class="tab-pane fade {% if active_tab == 'dlpd_3bln' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="bi bi-bar-chart"></i> DLPD 3 Bulan (‚Üë50%) - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ dlpd_3bln_html|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'naik' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="bi bi-arrow-up"></i> Data NAIK - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ naik_html_v2|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'turun' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5><i class="bi bi-arrow-down"></i> Data TURUN - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ turun_html_v2|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'div' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="bi bi-question"></i> Data DIV/NA - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ div_html_v2|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'jam_nyala' %}show active{% endif %}">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-clock"></i> Jam Nyala - Total: {{ total_rows }} Data</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">{{ jam_nyala_html|safe }}</div>
                    {{ pagination_html|safe }}
                </div>
            </div>
        </div>
    </div>

<!-- Modal Grafik -->
<div class="modal fade" id="grafikModal" tabindex="-1" aria-labelledby="grafikModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="grafikModalLabel">
                    <i class="bi bi-graph-up"></i> Grafik Pemakaian 6 Bulan
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="grafikLoadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Memuat grafik...</p>
                </div>
              <div id="grafikContent" style="display: none; height: 400px; position: relative;">
    <canvas id="grafikChart"></canvas>
</div>
                <div id="grafikError" class="alert alert-danger" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

    <!-- üîπ STATUS INDICATOR AUTO-SAVE -->
    <button id="saveVerifikasiBtn" class="btn btn-success btn-lg">
        <i class="bi bi-check-circle"></i> Auto-Save Aktif
    </button>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>

    
// =================== GLOBAL VARIABLES ===================
let saveTimeout;
let saveQueue = 0;

// =================== UTILITY FUNCTIONS ===================
function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.add('show');
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('show');
}

function open3Foto(idpel, blth) {
    const url = "https://portalapp.iconpln.co.id/acmt/DisplayBlobServlet1?idpel=";
    const getPrev = b => { 
        let y = +b.substr(0,4), m = +b.substr(4,2)-1; 
        if(!m){m=12;y--;} 
        return y+(m<10?'0'+m:m); 
    };
    const b1 = getPrev(blth), b2 = getPrev(b1);
    [blth, b1, b2].forEach((b,i) => window.open(`${url}${idpel}&blth=${b}`, `_f${i+1}`, `width=300,height=900,left=${10+310*i},top=10`));
}

// =================== AUTO-SAVE FUNCTIONS ===================
function autoSaveVerifikasi(idpel, blth, field, value) {
    console.log('üíæ Attempting to save:', {idpel, blth, field, value});
    
    if (!idpel || !blth || !field) {
        console.error('‚ùå Missing required fields:', {idpel, blth, field});
        return;
    }
    
    const row = document.querySelector(`tr[data-idpel="${idpel}"][data-blth="${blth}"]`);
    let unitup = null;
    
    if (row) {
        const cells = row.querySelectorAll('td');
        if (cells[1]) {
            unitup = cells[1].textContent.trim();
        }
    }
    
    console.log('üè¢ UNITUP detected:', unitup);
    
    saveQueue++;
    updateSaveStatus(true);
    
    fetch('/update_verifikasi_single', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            IDPEL: idpel,
            BLTH: blth,
            UNITUP: unitup,
            column: field,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        saveQueue--;
        if (data.success) {
            console.log('‚úÖ Auto-saved successfully!');
            showSaveSuccess();
        } else {
            console.error('‚ùå Save failed:', data.message);
            alert('‚ùå Gagal simpan: ' + data.message);
        }
        if (saveQueue === 0) {
            updateSaveStatus(false);
        }
    })
    .catch(error => {
        saveQueue--;
        console.error('‚ùå Network error:', error);
        alert('‚ùå Error jaringan: ' + error);
        if (saveQueue === 0) {
            updateSaveStatus(false);
        }
    });
}

function updateSaveStatus(saving) {
    const btn = document.getElementById('saveVerifikasiBtn');
    if (!btn) return;
    
    if (saving) {
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Menyimpan...';
        btn.classList.add('show');
        btn.disabled = true;
    } else {
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Tersimpan';
        setTimeout(() => {
            btn.classList.remove('show');
            btn.disabled = false;
        }, 2000);
    }
}

function showSaveSuccess() {
    console.log('‚úÖ Save success feedback shown');
}

// =================== TABLE SORTING FUNCTIONS ===================
function makeSortable(table) {
    const headers = table.querySelectorAll('thead th');
    const tbody = table.querySelector('tbody');
    
    if (!tbody) return;
    
    headers.forEach((header, columnIndex) => {
        const headerText = header.textContent.trim();
        if (!headerText || headerText === 'AKSI' || headerText === 'FOTO') {
            return;
        }
        
        header.classList.add('sortable');
        header.dataset.column = columnIndex;
        header.dataset.sortType = 'none';
        
        header.addEventListener('click', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }
            sortTable(table, columnIndex, this);
        });
    });
}

function sortTable(table, columnIndex, header) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    let sortType = header.dataset.sortType || 'none';
    let newSortType = sortType === 'asc' ? 'desc' : 'asc';
    
    table.querySelectorAll('thead th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc', 'sorted');
        th.dataset.sortType = 'none';
    });
    
    table.querySelectorAll('td').forEach(td => {
        td.classList.remove('sorted-column');
    });
    
    header.classList.add(newSortType === 'asc' ? 'sort-asc' : 'sort-desc');
    header.classList.add('sorted');
    header.dataset.sortType = newSortType;
    
    rows.sort((a, b) => {
        let aCell = a.cells[columnIndex];
        let bCell = b.cells[columnIndex];
        
        if (!aCell || !bCell) return 0;
        
        let aValue = getCellValue(aCell);
        let bValue = getCellValue(bCell);
        
        let aNum = parseFloat(aValue.replace(/,/g, '.'));
        let bNum = parseFloat(bValue.replace(/,/g, '.'));
        
        let result = 0;
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            result = aNum - bNum;
        } else {
            result = aValue.localeCompare(bValue, 'id', {numeric: true});
        }
        
        return newSortType === 'asc' ? result : -result;
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    rows.forEach(row => {
        if (row.cells[columnIndex]) {
            row.cells[columnIndex].classList.add('sorted-column');
        }
    });
    
    updateZebraStriping(tbody);
}

function getCellValue(cell) {
    const input = cell.querySelector('input');
    if (input) return input.value || '';
    
    const select = cell.querySelector('select');
    if (select) return select.value || select.textContent || '';
    
    return cell.textContent.trim();
}

function updateZebraStriping(tbody) {
    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        row.classList.remove('even-row');
        if (index % 2 === 1) {
            row.classList.add('even-row');
        }
    });
}

// =================== DOWNLOAD FUNCTIONS ===================
function initDownloadExcel() {
    const downloadBtn = document.getElementById("downloadExcelBtn");
    if (!downloadBtn) return;
    
    downloadBtn.addEventListener("click", function(e) {
        e.preventDefault();
        
        const activeTabLink = document.querySelector(".nav-link.active");
        if (!activeTabLink) {
            alert("‚ùå Pilih tab terlebih dahulu");
            return;
        }
        
        const tabName = activeTabLink.dataset.tab || activeTabLink.getAttribute('data-tab');
        if (!tabName) {
            alert("‚ùå Tab tidak ditemukan");
            return;
        }
        
        const currentParams = new URLSearchParams(window.location.search);
        const downloadUrl = new URL(window.location.origin + "/download_excel");
        downloadUrl.searchParams.set("tab", tabName);
        
        const filterParams = ["blth", "kdkelompok", "unitup_filter", "jam_nyala_min", "jam_nyala_max"];
        filterParams.forEach(param => {
            const value = currentParams.get(param);
            if (value) {
                downloadUrl.searchParams.set(param, value);
            }
        });
        
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
        this.disabled = true;
        
        window.location.href = downloadUrl.toString();
        
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-file-earmark-excel"></i> Download Data';
            this.disabled = false;
        }, 3000);
    });
}

function initDownloadHariBaca() {
    const btnDownloadHb = document.getElementById('btnDownloadHb');
    if (!btnDownloadHb) return;
    
    btnDownloadHb.addEventListener('click', function(e) {
        e.preventDefault();
        
        const activeTabLink = document.querySelector('.nav-link.active');
        if (!activeTabLink) {
            alert('‚ùå Pilih tab terlebih dahulu');
            return;
        }
        
        const activeTab = activeTabLink.dataset.tab || activeTabLink.getAttribute('data-tab');
        const mainBlthSelect = document.getElementById('blth');
        const input1Field = document.getElementById('input1');
        const input2Field = document.getElementById('input2');
        
        if (!mainBlthSelect || !input1Field || !input2Field) {
            alert('‚ùå Form fields tidak ditemukan');
            return;
        }
        
        const blth = mainBlthSelect.value.trim();
        const input1 = input1Field.value.trim().toUpperCase();
        const input2 = input2Field.value.trim().toUpperCase();
        
        if (!blth) {
            alert('‚ö†Ô∏è Pilih periode (BLTH) terlebih dahulu!');
            mainBlthSelect.focus();
            return;
        }
        
        if (!input1 || !input2) {
            alert('‚ö†Ô∏è Isi range kelompok (Dari - Sampai)!');
            return;
        }
        
        const validChars = ['1', '2', '3', '4', '5', '6', '7', '8', 'P', 'A', 'I'];
        if (!validChars.includes(input1) || !validChars.includes(input2)) {
            alert('‚ö†Ô∏è Input harus: 1-8, P, A, atau I');
            return;
        }
        
        const url = new URL(window.location.origin + "/download_excel_hb");
        url.searchParams.set('tab', activeTab);
        url.searchParams.set('blth', blth);
        url.searchParams.set('input1', input1);
        url.searchParams.set('input2', input2);
        
        // Ambil UNITUP filter jika ada
        const unitupSelect = document.querySelector('select[name="unitup_filter"]');
        if (unitupSelect && unitupSelect.value) {
            url.searchParams.set('unitup_filter', unitupSelect.value);
        }
        
        const originalHTML = this.innerHTML;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
        this.disabled = true;
        
        window.location.href = url.toString();
        
        setTimeout(() => {
            this.innerHTML = originalHTML;
            this.disabled = false;
        }, 3000);
    });
}

// =================== TRANSFORM CELLS TO INPUT ===================
function transformCellsToInputs() {
    document.querySelectorAll("table tbody tr").forEach((row) => {
        const cells = row.cells;
        
        const blth = cells[0]?.textContent.trim() || '';
        const idpel = cells[2]?.textContent.trim() || '';
        
        row.dataset.idpel = idpel;
        row.dataset.blth = blth;
        
        const table = row.closest('table');
        if (!table) return;
        
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        const hasilIdx = headers.indexOf('HASIL_PEMERIKSAAN');
        const stanIdx = headers.indexOf('STAN_VERIFIKASI');
        const tindakIdx = headers.indexOf('TINDAK_LANJUT');
        
        // HASIL_PEMERIKSAAN
        if (hasilIdx >= 0 && cells[hasilIdx]) {
            const existingSelect = cells[hasilIdx].querySelector('select');
            let current = '';
            
            if (existingSelect) {
                current = existingSelect.value || '';
            } else {
                const val = cells[hasilIdx].textContent.trim();
                current = (val === 'NULL' || val === '-- Pilih --' || !val) ? '' : val;
            }
            
            const hasilOptions = [
                '', 'SESUAI', 'TEMPER NYALA', 'SALAH STAN', 'SALAH FOTO', 
                'FOTO BURAM', 'ANOMALI PDL', 'LEBIH TAGIH', 'KURANG TAGIH', 
                'BKN FOTO KWH', 'BENCANA', '3BLN TANPA STAN', 'BACA ULANG', 'MASUK 720JN'
            ];
            
            let html = '<select class="verifikasi-select" data-field="HASIL_PEMERIKSAAN">';
            hasilOptions.forEach(opt => {
                const selected = opt === current ? 'selected' : '';
                const display = opt === '' ? '-- Pilih --' : opt;
                html += `<option value="${opt}" ${selected}>${display}</option>`;
            });
            html += '</select>';
            
            cells[hasilIdx].innerHTML = html;
        }
        
        // STAN_VERIFIKASI
        if (stanIdx >= 0 && cells[stanIdx]) {
            const existingInput = cells[stanIdx].querySelector('input');
            let current = '';
            
            if (existingInput) {
                current = existingInput.value || '';
            } else {
                const val = cells[stanIdx].textContent.trim();
                current = (val === 'NULL' || !val) ? '' : val;
            }
            
            cells[stanIdx].innerHTML = `<input type="number" class="verifikasi-input" data-field="STAN_VERIFIKASI" value="${current}" placeholder="Stan">`;
        }
        
        // TINDAK_LANJUT
        if (tindakIdx >= 0 && cells[tindakIdx]) {
            const existingInput = cells[tindakIdx].querySelector('input');
            let current = '';
            
            if (existingInput) {
                current = existingInput.value || '';
            } else {
                const val = cells[tindakIdx].textContent.trim();
                current = (val === 'NULL' || !val) ? '' : val;
            }
            
            cells[tindakIdx].innerHTML = `<input type="text" class="verifikasi-input" data-field="TINDAK_LANJUT" value="${current}" placeholder="Tindak lanjut...">`;
        }
    });
}

// =================== MAIN INITIALIZATION ===================
window.addEventListener('load', hideLoading);

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing application...');
    
    // 1. Auto-select latest BLTH
    const blthSelect = document.getElementById("blth");
    if (blthSelect && !blthSelect.value && blthSelect.options.length > 1) {
        blthSelect.selectedIndex = 1;
    }
    
    // 2. Clean \n from existing elements
    document.querySelectorAll('textarea, .form-control').forEach(elem => {
        if (elem.value && elem.value.includes('\\n')) {
            elem.value = elem.value.replace(/\\n/g, ' ').trim();
        }
    });

    document.querySelectorAll('select option').forEach(option => {
        if (option.textContent.includes('\\n')) {
            option.textContent = option.textContent.replace(/\\n/g, ' ').trim();
        }
    });

    document.querySelectorAll('td, th, div, span').forEach(elem => {
        if (elem.innerHTML.includes('\\n')) {
            elem.innerHTML = elem.innerHTML.replace(/\\n/g, ' ').replace(/\s+/g, ' ').trim();
        }
    });
    
    // 3. Transform cells to inputs
    transformCellsToInputs();
    
    // 4. SAHLWBP coloring
    document.querySelectorAll("table").forEach(t => {
        const headers = Array.from(t.querySelectorAll("thead th"));
        const idx = headers.findIndex(h => h.innerText.trim().toUpperCase() === "SAHLWBP");
        
        if (idx !== -1) {
            headers[idx].classList.add("sahlwbp-header");
            t.querySelectorAll("tbody tr").forEach(r => {
                const c = r.cells[idx];
                if (c) {
                    const value = parseFloat(c.innerText.replace(',','.'));
                    c.classList.add(value > 0 ? "sahlwbp-cell-blue-positive" : "sahlwbp-cell-blue");
                }
            });
        }
    });
    
    // 5. Initialize table sorting
    const tables = document.querySelectorAll('.table-responsive table');
    tables.forEach(table => makeSortable(table));
    
    // 6. Initialize downloads
    initDownloadExcel();
    initDownloadHariBaca();
    
    // 7. Highlight row on click
    document.querySelectorAll(".table-responsive table").forEach(table => {
        table.addEventListener("click", function (event) {
            const row = event.target.closest("tr");
            if (!row) return;
            table.querySelectorAll("tr.active-row").forEach(r => r.classList.remove("active-row"));
            row.classList.add("active-row");
        });
    });
    
    console.log('‚úÖ Application initialized successfully!');
});

// =================== EVENT DELEGATION ===================
// Auto-save on change (HASIL_PEMERIKSAAN)
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('verifikasi-select')) {
        const row = e.target.closest('tr');
        if (!row) return;
        
        const idpel = row.dataset.idpel;
        const blth = row.dataset.blth;
        const field = e.target.dataset.field;
        const value = e.target.value;
        
        row.classList.add('has-changes');
        autoSaveVerifikasi(idpel, blth, field, value);
    }
});

// Auto-save on input (TINDAK_LANJUT) - debounced
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('verifikasi-input') && e.target.dataset.field === 'TINDAK_LANJUT') {
        const row = e.target.closest('tr');
        if (!row) return;
        
        const idpel = row.dataset.idpel;
        const blth = row.dataset.blth;
        const field = e.target.dataset.field;
        const value = e.target.value;
        
        row.classList.add('has-changes');
        
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            autoSaveVerifikasi(idpel, blth, field, value);
        }, 1000);
    }
});

// Auto-save on blur (STAN_VERIFIKASI)
document.addEventListener('blur', function(e) {
    if (e.target.classList.contains('verifikasi-input') && e.target.dataset.field === 'STAN_VERIFIKASI') {
        const row = e.target.closest('tr');
        if (!row) return;
        
        const idpel = row.dataset.idpel;
        const blth = row.dataset.blth;
        const field = e.target.dataset.field;
        const value = e.target.value;
        
        row.classList.add('has-changes');
        autoSaveVerifikasi(idpel, blth, field, value);
    }
}, true);


/// ================================================================
// HANDLER: Grafik Button - IMPROVED VERSION
// ================================================================
$(document).on('click', '.grafik-btn', function(e) {
    e.preventDefault();
    
    const idpel = $(this).data('idpel');
    const blth = $(this).data('blth');
    const unitup = $(this).data('unitup') || '';
    
    console.log('üìä Grafik clicked:', { idpel, blth, unitup });
    
    // Validasi input
    if (!idpel || !blth) {
        alert('‚ö†Ô∏è Data IDPEL atau BLTH tidak lengkap');
        return;
    }
    
    // Reset modal
    $('#grafikLoadingSpinner').show();
    $('#grafikContent').hide();
    $('#grafikError').hide();
    $('#grafikModalLabel').html(`<i class="bi bi-graph-up"></i> Grafik Pemakaian 6 Bulan - IDPEL: ${idpel}`);
    
    // Destroy chart lama jika ada
    if (window.grafikChartInstance) {
        window.grafikChartInstance.destroy();
        window.grafikChartInstance = null;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('grafikModal'));
    modal.show();
    
    // Fetch data dengan timeout
    const fetchTimeout = setTimeout(() => {
        $('#grafikLoadingSpinner').hide();
        $('#grafikError').show().html(
            `<strong>Timeout:</strong> Request memakan waktu terlalu lama. Silakan coba lagi.`
        );
    }, 15000); // 15 detik timeout
    
    $.ajax({
        url: `/api/grafik/${idpel}`,
        method: 'GET',
        data: { 
            blth: blth, 
            ulp: unitup 
        },
        timeout: 15000,
        success: function(response) {
            clearTimeout(fetchTimeout);
            console.log('‚úÖ Grafik data received:', response);
            
            // Validasi response
            if (!response.labels || !response.lwbppakai || !response.jam_nyala) {
                $('#grafikLoadingSpinner').hide();
                $('#grafikError').show().html(
                    `<strong>Error:</strong> Data tidak lengkap dari server`
                );
                return;
            }
            
            $('#grafikLoadingSpinner').hide();
            $('#grafikContent').show();
            
            // Update modal title dengan info tambahan
            $('#grafikModalLabel').html(
                `<i class="bi bi-graph-up"></i> Grafik Pemakaian - IDPEL: ${idpel} 
                ${response.unitup && response.unitup !== 'ALL' ? `(${response.unitup})` : ''}`
            );
            
            // Render chart
            const ctx = document.getElementById('grafikChart').getContext('2d');
            window.grafikChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
        labels: response.labels,
        datasets: [
            {
                label: 'KWH Pemakaian',
                data: response.lwbppakai,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.3,
                fill: true,
                yAxisID: 'y',
                pointRadius: 5,
                pointHoverRadius: 7,
            },
            {
                label: 'Jam Nyala',
                data: response.jam_nyala,
                borderColor: 'rgb(255, 159, 64)',
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                tension: 0.3,
                fill: true,
                yAxisID: 'y1',
                pointRadius: 5,
                pointHoverRadius: 7,
            },
            {
                label: 'Delta KWH',
                data: response.delta,
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                tension: 0.3,
                fill: true,
                yAxisID: 'y',
                pointRadius: 5,
                pointHoverRadius: 7,
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ‚úÖ TETAP FALSE tapi dengan height container
        animation: {
            duration: 0 // ‚úÖ Ubah dari false ke 0
        },
        layout: {
            padding: {
                top: 10,
                right: 10,
                bottom: 10,
                left: 10
            }
        },
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    font: { size: 13, weight: 'bold' },
                    padding: 15,
                    usePointStyle: true
                }
            },
            title: {
                display: true,
                text: `Daya: ${response.daya ? response.daya[response.daya.length-1] : 'N/A'} VA`,
                font: { size: 14, weight: 'bold' },
                padding: { top: 10, bottom: 20 }
            },
            tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 },
                padding: 12,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        
                        const value = context.parsed.y;
                        
                        if (context.dataset.label === 'Jam Nyala') {
                            label += value.toLocaleString('id-ID', {
                                minimumFractionDigits: 1,
                                maximumFractionDigits: 1
                            }) + ' jam';
                        } else {
                            label += value.toLocaleString('id-ID') + ' kWh';
                        }
                        
                        return label;
                    },
                    afterLabel: function(context) {
                        if (response.labels_raw && response.labels_raw[context.dataIndex]) {
                            return `BLTH: ${response.labels_raw[context.dataIndex]}`;
                        }
                        return '';
                    }
                }
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'KWH (Pemakaian & Delta)',
                    font: { weight: 'bold', size: 13 }
                },
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString('id-ID');
                    },
                    font: { size: 11 }
                },
                grid: { 
                    color: 'rgba(0,0,0,0.1)',
                    drawBorder: true
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Jam Nyala',
                    font: { weight: 'bold', size: 13 }
                },
                grid: { 
                    drawOnChartArea: false 
                },
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString('id-ID', {
                            minimumFractionDigits: 1,
                            maximumFractionDigits: 1
                        });
                    },
                    font: { size: 11 }
                }
            },
        }
    }
});
        },
        error: function(xhr, status, error) {
            clearTimeout(fetchTimeout);
            console.error('‚ùå Grafik error:', { xhr, status, error });
            
            $('#grafikLoadingSpinner').hide();
            
            let errorMessage = 'Gagal memuat grafik';
            let errorDetail = '';
            
            if (xhr.responseJSON) {
                errorMessage = xhr.responseJSON.error || errorMessage;
                errorDetail = xhr.responseJSON.detail || '';
            } else if (xhr.status === 404) {
                errorMessage = 'Data tidak ditemukan';
                errorDetail = `IDPEL ${idpel} tidak memiliki data untuk 6 bulan terakhir`;
            } else if (xhr.status === 0) {
                errorMessage = 'Koneksi gagal';
                errorDetail = 'Tidak dapat terhubung ke server. Periksa koneksi internet Anda.';
            } else if (status === 'timeout') {
                errorMessage = 'Request timeout';
                errorDetail = 'Permintaan memakan waktu terlalu lama';
            } else {
                errorDetail = `Status: ${xhr.status} - ${error}`;
            }
            
            $('#grafikError').show().html(`
                <strong>${errorMessage}</strong>
                ${errorDetail ? `<br><small>${errorDetail}</small>` : ''}
                <br><br>
                <small class="text-muted">
                    Debug Info: IDPEL=${idpel}, BLTH=${blth}, ULP=${unitup || 'ALL'}
                </small>
            `);
        }
    });
});

// Cleanup saat modal ditutup
$('#grafikModal').on('hidden.bs.modal', function() {
    if (window.grafikChartInstance) {
        window.grafikChartInstance.destroy();
        window.grafikChartInstance = null;
    }
    
    // Reset semua view
    $('#grafikLoadingSpinner').hide();
    $('#grafikContent').hide();
    $('#grafikError').hide();
});
</script>
{% endblock %}